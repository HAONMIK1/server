### 잔액 조회 API
```mermaid
sequenceDiagram
    actor  클라이언트
    participant 컨트롤러
    participant 서비스
    participant 레포지토리
    participant 데이터베이스


    Note over 클라이언트,데이터베이스: 잔액 조회 API

    클라이언트->>컨트롤러: 잔액 조회 요청
    컨트롤러->>서비스: 잔액 조회 요청
    서비스->>레포지토리: 잔액 조회
    레포지토리->>데이터베이스: 잔액 조회
    데이터베이스-->>레포지토리: 현재 잔액
    레포지토리-->>서비스:  현재 잔액
    서비스-->>컨트롤러:  현재 잔액
    컨트롤러-->>클라이언트:  현재 잔액 응답


 ```
### 잔액 충전 API
```mermaid
sequenceDiagram
    actor  클라이언트
    participant 컨트롤러
    participant 서비스
    participant 레포지토리
    participant 데이터베이스


    Note over 클라이언트,데이터베이스: 잔액 충전/조회 API

    클라이언트->>컨트롤러: 잔액 충전 요청
    컨트롤러->>서비스: 잔액 충전 요청

    서비스->>서비스: ReentrantLock(userId)

    서비스->>레포지토리: 트랜잭션 시작
    레포지토리-->>서비스: 트랜잭션 시작

    서비스->>레포지토리: 유저 잔액 확인
    레포지토리->>데이터베이스: 유저 잔액 확인
    데이터베이스-->>레포지토리: 유저 잔액 데이터
    레포지토리-->>서비스: 유저 잔액

    alt 최소 충전,최대충전,잔액 한도 초과
        서비스->>서비스: 트랜잭션 롤백
        서비스->>서비스: unlock(userId)
        서비스-->>컨트롤러: 발급 실패
        컨트롤러-->>클라이언트: 최소,최대충전 부족
    else 발급가능
        서비스->>레포지토리: 유저 잔액 업데이트
        레포지토리->>데이터베이스: 유저 잔액 업데이트
        데이터베이스-->>레포지토리: 업데이트 완료
        레포지토리-->>서비스: 완료

        서비스->>레포지토리: 충전 이력 저장
        레포지토리->>데이터베이스: 충전 이력 저장
        데이터베이스-->>레포지토리: 저장 완료
        레포지토리-->>서비스: 완료

        서비스->>서비스: 트랜잭션 커밋
        서비스->>서비스: unlock(userId)

        서비스-->>컨트롤러:  현재 잔액
        컨트롤러-->>클라이언트:  현재 잔액 응답

    end



 ``` 
### 상품 목록 조회 API   
```mermaid
sequenceDiagram

actor  클라이언트
participant 컨트롤러
participant 서비스
participant 레포지토리
participant 데이터베이스

    Note over 클라이언트, 데이터베이스:  상품 목록 조회

    클라이언트->>컨트롤러: 상품 조회 요청
    컨트롤러->>서비스: 상품 조회 요청
    par 비동기: 조회수 업데이트
        서비스--)레포지토리: 조회수 증가 요청 (비동기)
        레포지토리--)데이터베이스: 조회수 증가 (비동기)
    and 상품 데이터 조회
        서비스->>레포지토리: 상품 조회 요청
        레포지토리->>데이터베이스: 상품 조회
        데이터베이스-->>레포지토리: 상품 정보
        레포지토리-->>서비스: 상품 정보
    end

 ``` 
### 선착순 쿠폰 발급 API
 ```mermaid
sequenceDiagram

actor  클라이언트
participant 컨트롤러
participant 서비스
participant 레포지토리
participant 데이터베이스

    Note over 클라이언트, 데이터베이스: 선착순 쿠폰 발급

    클라이언트->>컨트롤러: 선착순 쿠폰 발급 요청
    컨트롤러->>서비스: 선착순 쿠폰 발급 요청

    서비스->>레포지토리: 트랜잭션 시작
    레포지토리-->>서비스: 트랜잭션 시작

    서비스->>레포지토리: 쿠폰 재고 조회 (FOR UPDATE)
    레포지토리->>데이터베이스: SELECT ... FOR UPDATE
    데이터베이스-->>레포지토리: 쿠폰 재고 (락 보유)
    레포지토리-->>서비스: 쿠폰 조회

    서비스->>레포지토리: 유저 쿠폰 존재 여부 요청
    레포지토리->>데이터베이스: 유저 쿠폰 존재 여부
    데이터베이스-->>레포지토리: 결과 반환
    레포지토리-->>서비스: 유저 쿠폰 존재 여부

    alt 유저가 이미 쿠폰 보유
        서비스->>레포지토리: 트랜잭션 롤백
        레포지토리-->>서비스: 롤백 완료
        서비스-->>컨트롤러: 발급 실패
        컨트롤러-->>클라이언트: 쿠폰 보유
    else 쿠폰 품절
        서비스->>레포지토리: 트랜잭션 롤백
        레포지토리-->>서비스: 롤백 완료
        서비스-->>컨트롤러: 발급 실패
        컨트롤러-->>클라이언트: 쿠폰 품절
    else 발급가능
        서비스->>레포지토리: 쿠폰 재고 차감
        레포지토리->>데이터베이스: 쿠폰 재고 차감
        데이터베이스-->>레포지토리: 재고 차감 완료
        레포지토리-->>서비스: 완료

        서비스->>레포지토리: 유저 쿠폰 발급 저장
        레포지토리->>데이터베이스: 유저 쿠폰 발급 저장
        데이터베이스-->>레포지토리: 저장 완료
        레포지토리-->>서비스: 완료

        서비스->>레포지토리: 트랜잭션 커밋
        레포지토리-->>서비스: 커밋 완료

        서비스-->>컨트롤러: 발급 성공 응답
        컨트롤러-->>클라이언트: 쿠폰 발급 완료
    end
 ``` 
### 주문 API 
```mermaid
sequenceDiagram
    actor 사용자
    participant 주문
    participant 상품
    participant 쿠폰

    사용자->>주문: 주문 생성 요청

    주문->>상품: 상품 정보 확인
    상품-->>주문: 상품 정보
    
    alt 쿠폰 사용 시
        주문->>쿠폰: 할인액 계산
        쿠폰-->>주문: 할인 정보
    end
    
    주문->>주문: 주문 생성 (총금액, 할인금액, 최종금액, 대기상태)

    주문-->>사용자: 주문 정보 응답
```

### 결제 API 
```mermaid
sequenceDiagram
    actor 사용자
    participant 결제
    participant 주문
    participant 상품
    participant 잔액
    participant 쿠폰

    사용자->>결제: 결제 처리 요청

    결제->>주문: 주문 정보 확인
    주문-->>결제: 주문 정보

    loop 각 주문 상품
        결제->>상품: 재고 차감 및 판매량 증가
        상품-->>결제: 처리 완료
    end

    결제->>잔액: 잔액 사용
    잔액-->>결제: 처리 완료
    
    alt 쿠폰 사용 시
        결제->>쿠폰: 쿠폰 사용 처리
        쿠폰-->>결제: 처리 완료
    end

    결제->>결제: 결제 내역 저장

    결제->>주문: 주문 완료 처리
    주문-->>결제: 처리 완료

    결제-->>사용자: 결제 완료 응답 

 ```   
### 인기 상품 조회 API    
```mermaid
sequenceDiagram

actor  클라이언트
participant 컨트롤러
participant 서비스
participant 레포지토리
participant 데이터베이스

    Note over 서비스, 데이터베이스: 배치 처리 (15분마다 실행)
    서비스->>레포지토리: 최근 3일 판매량 통계 조회
    레포지토리->>데이터베이스: 상품 판매량,조회수,최신등록순 데이터 조회
    데이터베이스-->>레포지토리: 판매량 높은 5개 상품 데이터(판매량,조회수,최신등록순)
    레포지토리-->>서비스: 판매량 높은 5개 상품 데이터(판매량,조회수,최신등록순)

    서비스->>레포지토리: 인기 상품 테이블 업데이트
    레포지토리->>데이터베이스: 인기 상품 데이터 저장
    데이터베이스-->>레포지토리: 저장 완료
    레포지토리-->>서비스: 업데이트 완료
    Note over 클라이언트, 데이터베이스: 인기 상품 조회
    클라이언트->>컨트롤러: 인기 상품 조회
    컨트롤러->>서비스: 인기 상품 조회
    서비스->>레포지토리: 인기 상품 조회
    레포지토리->>데이터베이스: 인기 상품 기준 조회
    데이터베이스-->>레포지토리: 인기 상품 리스트
    레포지토리-->>서비스: 인기 상품 리스트
    서비스-->>컨트롤러: 인기 상품 리스트 응답
    컨트롤러-->>클라이언트: 인기 상품 리스트
 ``` 
