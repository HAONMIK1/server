```mermaid
sequenceDiagram
    actor  클라이언트
    participant 컨트롤러
    participant 서비스
    participant 레포지토리
    participant 데이터베이스


    Note over 클라이언트,데이터베이스: 잔액 충전/조회 API

    클라이언트->>컨트롤러: 잔액 충전 요청
    컨트롤러->>서비스: 잔액 충전 요청

    서비스->>서비스: ReentrantLock(userId)

    서비스->>레포지토리: 트랜잭션 시작
    레포지토리-->>서비스: 트랜잭션 시작

    서비스->>레포지토리: 유저 잔액 확인
    레포지토리->>데이터베이스: 유저 잔액 확인
    데이터베이스-->>레포지토리: 유저 잔액 데이터
    레포지토리-->>서비스: 유저 잔액

    alt 최소 충전,최대충전,잔액 한도 초과
        서비스->>서비스: 트랜잭션 롤백
        서비스->>서비스: unlock(userId)
        서비스-->>컨트롤러: 발급 실패
        컨트롤러-->>클라이언트: 최소,최대충전 부족
    else 발급가능
        서비스->>레포지토리: 유저 잔액 업데이트
        레포지토리->>데이터베이스: 유저 잔액 업데이트
        데이터베이스-->>레포지토리: 업데이트 완료
        레포지토리-->>서비스: 완료

        서비스->>레포지토리: 충전 이력 저장
        레포지토리->>데이터베이스: 충전 이력 저장
        데이터베이스-->>레포지토리: 저장 완료
        레포지토리-->>서비스: 완료

        서비스->>서비스: 트랜잭션 커밋
        서비스->>서비스: unlock(userId)

        서비스->>레포지토리: 잔액 조회
        레포지토리->>데이터베이스: 잔액 조회
        데이터베이스-->>레포지토리: 현재 잔액
        레포지토리-->>서비스:  현재 잔액
        서비스-->>컨트롤러:  현재 잔액
        컨트롤러-->>클라이언트:  현재 잔액 응답

    end



 ``` 
    
```mermaid
sequenceDiagram

actor  클라이언트
participant 컨트롤러
participant 서비스
participant 레포지토리
participant 데이터베이스

    Note over 클라이언트, 데이터베이스:  상품 목록 조회

    클라이언트->>컨트롤러: 상품 조회 요청
    컨트롤러->>서비스: 상품 조회 요청
    par 비동기: 조회수 업데이트
        서비스--)레포지토리: 조회수 증가 요청 (비동기)
        레포지토리--)데이터베이스: 조회수 증가 (비동기)
    and 상품 데이터 조회
        서비스->>레포지토리: 상품 조회 요청
        레포지토리->>데이터베이스: 상품 조회
        데이터베이스-->>레포지토리: 상품 정보
        레포지토리-->>서비스: 상품 정보
    end

 ``` 
 ```mermaid
sequenceDiagram

actor  클라이언트
participant 컨트롤러
participant 서비스
participant 레포지토리
participant 데이터베이스

    Note over 클라이언트, 데이터베이스: 선착순 쿠폰 발급

    클라이언트->>컨트롤러: 선착순 쿠폰 발급 요청
    컨트롤러->>서비스: 선착순 쿠폰 발급 요청

    서비스->>레포지토리: 트랜잭션 시작
    레포지토리-->>서비스: 트랜잭션 시작

    서비스->>레포지토리: 쿠폰 재고 조회 (FOR UPDATE)
    레포지토리->>데이터베이스: SELECT ... FOR UPDATE
    데이터베이스-->>레포지토리: 쿠폰 재고 (락 보유)
    레포지토리-->>서비스: 쿠폰 조회

    서비스->>레포지토리: 유저 쿠폰 존재 여부 요청
    레포지토리->>데이터베이스: 유저 쿠폰 존재 여부
    데이터베이스-->>레포지토리: 결과 반환
    레포지토리-->>서비스: 유저 쿠폰 존재 여부

    alt 유저가 이미 쿠폰 보유
        서비스->>레포지토리: 트랜잭션 롤백
        레포지토리-->>서비스: 롤백 완료
        서비스-->>컨트롤러: 발급 실패
        컨트롤러-->>클라이언트: 쿠폰 보유
    else 쿠폰 품절
        서비스->>레포지토리: 트랜잭션 롤백
        레포지토리-->>서비스: 롤백 완료
        서비스-->>컨트롤러: 발급 실패
        컨트롤러-->>클라이언트: 쿠폰 품절
    else 발급가능
        서비스->>레포지토리: 쿠폰 재고 차감
        레포지토리->>데이터베이스: 쿠폰 재고 차감
        데이터베이스-->>레포지토리: 재고 차감 완료
        레포지토리-->>서비스: 완료

        서비스->>레포지토리: 유저 쿠폰 발급 저장
        레포지토리->>데이터베이스: 유저 쿠폰 발급 저장
        데이터베이스-->>레포지토리: 저장 완료
        레포지토리-->>서비스: 완료

        서비스->>레포지토리: 트랜잭션 커밋
        레포지토리-->>서비스: 커밋 완료

        서비스-->>컨트롤러: 발급 성공 응답
        컨트롤러-->>클라이언트: 쿠폰 발급 완료
    end
 ``` 
```mermaid
sequenceDiagram

actor  클라이언트
participant 컨트롤러
participant 서비스
participant 레포지토리
participant 데이터베이스
participant 데이터플랫폼

    Note over 클라이언트, 데이터플랫폼: 주문/결제 API

    클라이언트->>컨트롤러: 주문 요청
    컨트롤러->>서비스: 주문 요청

%% 쿠폰 유효성 확인
    서비스->>레포지토리: 사용자 쿠폰 조회
    레포지토리->>데이터베이스: 사용자 쿠폰 조회
    데이터베이스-->>레포지토리: 쿠폰 정보
    레포지토리-->>서비스: 쿠폰 정보

%% 사용자 잔액 정보 조회
    서비스->>레포지토리: 사용자 잔액 조회
    레포지토리->>데이터베이스: 사용자 잔액 조회
    데이터베이스-->>레포지토리: 사용자 잔액
    레포지토리-->>서비스: 사용자 잔액

%% 결제 금액 계산
    서비스->>서비스: 총 결제 금액 계산 (할인 적용)
    서비스->>서비스: 잔액으로 결제 가능 여부 판단
    alt 잔액부족시
        서비스-->>컨트롤러: 결제 실패
        컨트롤러-->>클라이언트: 잔액 부족
    end

%% 주문 정보 저장 
    서비스->>레포지토리: 주문 정보 저장 (총금액, 할인금액, 최종금액, 대기상태)
    레포지토리->>데이터베이스: 주문 정보 저장
    데이터베이스-->>레포지토리: 저장 완료
    레포지토리-->>서비스: 저장 완료

%% 트랜잭션 시작
    서비스->>레포지토리: 트랜잭션 시작
    레포지토리-->>서비스: 트랜잭션 시작

%% 상품별 재고 확인 및 차감 (FOR UPDATE)
    loop 각 상품에 대해
        서비스->>레포지토리: 상품 재고 조회 (FOR UPDATE)
        레포지토리->>데이터베이스: SELECT ... FOR UPDATE
        데이터베이스-->>레포지토리: 상품 정보 (락 보유)
        레포지토리-->>서비스: 상품 정보
        서비스->>서비스: 재고 확인 및 차감 가능 여부 판단
        alt 재고 없을시
            서비스->>레포지토리: 트랜잭션 롤백
            레포지토리-->>서비스: 롤백 완료
            서비스->>레포지토리: 주문 상태 업데이트 (실패)
            레포지토리->>데이터베이스: 주문 상태 업데이트
            데이터베이스-->>레포지토리: 업데이트 완료
            레포지토리-->>서비스: 완료
            서비스-->>컨트롤러: 실패 응답
            컨트롤러-->>클라이언트: 재고 부족
        else 재고 있을시
            서비스->>레포지토리: 상품 재고 차감
            레포지토리->>데이터베이스: 상품 재고 차감
            데이터베이스-->>레포지토리: 재고 차감 완료
            레포지토리-->>서비스: 완료

            alt 재고가 0이 되었을 때
                서비스->>레포지토리: 상품 상태 업데이트 (품절)
                레포지토리->>데이터베이스: 상품 상태 업데이트
                데이터베이스-->>레포지토리: 상태 업데이트 완료
                레포지토리-->>서비스: 완료
            end

            서비스->>레포지토리: 상품 판매수 업데이트
            레포지토리->>데이터베이스: 상품 판매수 업데이트
            데이터베이스-->>레포지토리: 판매수 업데이트 완료
            레포지토리-->>서비스: 완료
        end
    end

%% 사용자 잔액 차감
    서비스->>레포지토리: 사용자 잔액 차감
    레포지토리->>데이터베이스: 사용자 잔액 차감
    데이터베이스-->>레포지토리: 잔액 차감 완료
    레포지토리-->>서비스: 완료

    서비스->>레포지토리: 잔액사용 이력
    레포지토리->>데이터베이스:  잔액사용 이력
    데이터베이스-->>레포지토리: 이력 저장
    레포지토리-->>서비스: 완료

%% 쿠폰 사용 처리
    alt 쿠폰 사용시
        서비스->>레포지토리: 쿠폰 사용 처리
        레포지토리->>데이터베이스: 쿠폰 사용 처리
        데이터베이스-->>레포지토리: 쿠폰 사용 처리 완료
        레포지토리-->>서비스: 완료
    end

%% 주문 상태 업데이트 (완료)
    서비스->>레포지토리: 주문 상태 업데이트 (완료)
    레포지토리->>데이터베이스: 주문 상태 업데이트
    데이터베이스-->>레포지토리: 상태 업데이트 완료
    레포지토리-->>서비스: 완료

%% 결제 내역 저장
    서비스->>레포지토리: 결제 내역 저장
    레포지토리->>데이터베이스: 결제 내역 저장
    데이터베이스-->>레포지토리: 결제 내역 완료
    레포지토리-->>서비스: 완료

%% 트랜잭션 커밋
    서비스->>레포지토리: 트랜잭션 커밋
    레포지토리-->>서비스: 커밋 완료

%% 데이터 플랫폼 전송
    서비스->>데이터플랫폼: 데이터 플랫폼 주문 데이터 전송
    데이터플랫폼-->>서비스: 전송 완료

    서비스-->>컨트롤러: 결제 완료 응답
    컨트롤러-->>클라이언트: 결제 완료



 ```   
     
```mermaid
sequenceDiagram

actor  클라이언트
participant 컨트롤러
participant 서비스
participant 레포지토리
participant 데이터베이스

    Note over 서비스, 데이터베이스: 배치 처리 (15마다 실행)
    서비스->>레포지토리: 최근 3일 판매량 통계 조회
    레포지토리->>데이터베이스: 상품별 판매량 데이터 조회
    데이터베이스-->>레포지토리: 판매량 높은 5개 상품 데이터
    레포지토리-->>서비스: 판매량 높은 5개 상품 데이터

    서비스->>레포지토리: 인기 상품 테이블 업데이트
    레포지토리->>데이터베이스: 인기 상품 데이터 저장
    데이터베이스-->>레포지토리: 저장 완료
    레포지토리-->>서비스: 업데이트 완료
    Note over 클라이언트, 데이터베이스: 인기 상품 조회
    클라이언트->>컨트롤러: 인기 상품 조회
    컨트롤러->>서비스: 인기 상품 조회
    서비스->>레포지토리: 인기 상품 조회
    레포지토리->>데이터베이스: 인기 상품 기준 조회
    데이터베이스-->>레포지토리: 인기 상품 리스트
    레포지토리-->>서비스: 인기 상품 리스트
    서비스-->>컨트롤러: 인기 상품 리스트 응답
    컨트롤러-->>클라이언트: 인기 상품 리스트
 ``` 
