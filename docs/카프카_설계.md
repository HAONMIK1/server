# 카프카를 활용한 비즈니스 프로세스 개선 설계 문서

## 1. 개요

### 1.1 개선 목표
- **선착순 쿠폰 발급 시스템**: 동시성 제어 및 순차 처리 보장
- **실시간 주문 정보 발행 시스템**: 비동기 이벤트 처리 및 확장성 확보

### 1.2 카프카 활용 전략
- **Producer-Consumer 패턴**: 비동기 메시지 처리
- **파티션 키 활용**: 순차 처리 보장
- **트랜잭션 이벤트**: 데이터 일관성 유지

## 2. 카프카 구성 설계

### 2.1 카프카 클러스터 구성
```yaml
# docker-compose.yml
version: '3.8'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
```

### 2.2 토픽 설계

| 토픽명 | 파티션 수 | 복제 팩터 | 키 타입 | 설명 |
|--------|-----------|-----------|---------|------|
| `coupon-publish-request` | 3 | 1 | String (couponId) | 쿠폰 발급 요청 |
| `order-completed` | 3 | 1 | String (orderId) | 주문 완료 이벤트 |

### 2.3 Consumer Group 설계

| Consumer Group | 토픽 | 인스턴스 수 | 처리 방식 |
|----------------|------|-------------|-----------|
| `coupon-consumer-group` | `coupon-publish-request` | 1 | 순차 처리 |
| `order-consumer-group` | `order-completed` | 3 | 병렬 처리 |

## 3. 비즈니스 시퀀스 다이어그램

### 3.1 선착순 쿠폰 발급 시스템

```mermaid
sequenceDiagram
    actor 사용자
    participant 컨트롤러
    participant CouponEventPublisher
    participant Kafka
    participant CouponEventConsumer
    participant CouponService
    participant 데이터베이스

    Note over 사용자, 데이터베이스: 선착순 쿠폰 발급 프로세스

    사용자->>컨트롤러: POST /api/v1/users/{userId}/coupons/{couponId}/issue
    컨트롤러->>CouponEventPublisher: publishCouponRequest(request)
    CouponEventPublisher->>Kafka: 메시지 발행 (키: couponId)
    Kafka-->>CouponEventPublisher: 발행 확인
    CouponEventPublisher-->>컨트롤러: 발행 완료
    컨트롤러-->>사용자: "요청 접수됨" 즉시 응답

    Note over Kafka, CouponEventConsumer: 파티션 키로 순차 처리
    Kafka->>CouponEventConsumer: 메시지 수신
    CouponEventConsumer->>CouponService: 쿠폰 발급 처리
    CouponService->>데이터베이스: 트랜잭션 시작
    CouponService->>데이터베이스: 쿠폰 조회
    데이터베이스-->>CouponService: 쿠폰 정보
    CouponService->>데이터베이스: 중복 발급 확인
    데이터베이스-->>CouponService: 중복 여부

    alt 재고 부족 또는 중복 발급
        CouponService->>데이터베이스: 트랜잭션 롤백
        CouponService-->>CouponEventConsumer: 발급 실패
        CouponEventConsumer-->>Kafka: 메시지 처리 완료
    else 발급 가능
        CouponService->>데이터베이스: UserCoupon 생성
        CouponService->>데이터베이스: 쿠폰 발급 수량 증가
        CouponService->>데이터베이스: 트랜잭션 커밋
        CouponService-->>CouponEventConsumer: 발급 성공
        CouponEventConsumer-->>Kafka: 메시지 처리 완료
    end
```

### 3.2 실시간 주문 정보 발행 시스템

```mermaid
sequenceDiagram
    actor 사용자
    participant PaymentService
    participant OrderEventPublisher
    participant Kafka
    participant OrderEventConsumer
    participant 외부시스템

    Note over 사용자, 외부시스템: 주문 완료 이벤트 처리

    사용자->>PaymentService: 결제 처리 요청
    PaymentService->>PaymentService: 결제 처리 (트랜잭션)
    PaymentService->>OrderEventPublisher: OrderCompletedEvent 발행
    OrderEventPublisher->>Kafka: 메시지 발행 (키: orderId)
    Kafka-->>OrderEventPublisher: 발행 확인
    OrderEventPublisher-->>PaymentService: 발행 완료
    PaymentService-->>사용자: 결제 완료 응답

    Note over Kafka, OrderEventConsumer: 비동기 이벤트 처리
    Kafka->>OrderEventConsumer: 메시지 수신
    OrderEventConsumer->>외부시스템: 알림톡 발송
    OrderEventConsumer->>외부시스템: 데이터 분석 업데이트
    OrderEventConsumer->>외부시스템: 모니터링 알림
    OrderEventConsumer-->>Kafka: 메시지 처리 완료
```

## 4. 카프카 설정

### 4.1 Producer 설정
```java
@Configuration
@EnableKafka
public class KafkaConfig {
    
    @Bean
    public ProducerFactory<String, String> producerFactory() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put("bootstrap.servers", "localhost:9092");
        configProps.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        configProps.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        return new DefaultKafkaProducerFactory<>(configProps);
    }
    
    @Bean
    public KafkaTemplate<String, String> kafkaTemplate() {
        return new KafkaTemplate<>(producerFactory());
    }
}
```

### 4.2 Consumer 설정
```java
@Bean
public ConsumerFactory<String, String> consumerFactory() {
    Map<String, Object> configProps = new HashMap<>();
    configProps.put("bootstrap.servers", "localhost:9092");
    configProps.put("group.id", "coupon-consumer-group");
    configProps.put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
    configProps.put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
    configProps.put("auto.offset.reset", "earliest");
    return new DefaultKafkaConsumerFactory<>(configProps);
}
```




