# Apache Kafka 기초 개념 및 구현 가이드

## 1. Apache Kafka란?

Apache Kafka는 고성능, 분산 이벤트 스트리밍 플랫폼입니다. 실시간 데이터 파이프라인과 스트리밍 애플리케이션을 구축하기 위해 설계되었습니다.

### 주요 특징
- **고성능**: 초당 수백만 메시지 처리 가능
- **확장성**: 수평적 확장으로 처리량 증가
- **내구성**: 디스크에 메시지 저장으로 데이터 손실 방지
- **실시간**: 실시간 스트리밍 처리 지원
- **분산**: 여러 서버에 분산 배포 가능

## 2. 카프카 핵심 구성요소

### 2.1 Broker
- 카프카 서버의 기본 단위
- 메시지를 저장하고 관리하는 역할
- 여러 브로커가 클러스터를 구성하여 고가용성 제공
- 각 브로커는 고유한 ID를 가짐

### 2.2 Topic
- 메시지가 저장되는 논리적 컨테이너
- 카테고리별로 메시지를 분류하는 용도
- 예: `orders`, `payments`, `user-events` 등
- 여러 파티션으로 분할되어 병렬 처리 가능

### 2.3 Partition
- Topic을 여러 개의 파티션으로 분할
- 각 파티션은 순서가 보장되는 메시지 시퀀스
- 병렬 처리와 확장성을 위한 핵심 요소
- 파티션 내에서는 메시지 순서 보장, 파티션 간에는 순서 보장하지 않음

### 2.4 Producer
- 메시지를 Topic에 발행하는 클라이언트
- 메시지 전송 시 파티션 선택 전략 사용
- Round-robin, Key-based, Custom partitioning 지원
- 배치 처리로 성능 최적화

### 2.5 Consumer
- Topic에서 메시지를 소비하는 클라이언트
- Consumer Group으로 그룹화하여 병렬 처리
- 각 파티션은 Consumer Group 내에서 하나의 Consumer만 처리
- Offset을 통해 메시지 소비 위치 추적

### 2.6 Consumer Group
- 여러 Consumer를 논리적으로 그룹화
- 파티션을 Consumer Group 내에서 분산 처리
- 동일한 Consumer Group 내에서는 메시지 중복 소비 방지
- 다른 Consumer Group은 동일한 메시지를 각각 소비 가능

## 3. 카프카 데이터 흐름

### 3.1 Producer → Topic → Consumer 흐름
```
Producer → Topic (Partition 0, 1, 2) → Consumer Group (Consumer 1, 2, 3)
```

### 3.2 파티션과 Consumer 매핑
- 파티션 수 = Consumer 수: 1:1 매핑
- 파티션 수 > Consumer 수: 일부 Consumer가 여러 파티션 처리
- 파티션 수 < Consumer 수: 일부 Consumer가 유휴 상태

### 3.3 메시지 전송 과정
1. Producer가 메시지를 특정 Topic으로 전송
2. 메시지는 파티션 선택 전략에 따라 특정 파티션에 저장
3. Consumer Group의 Consumer들이 각 파티션에서 메시지 소비
4. Offset을 통해 소비 위치 추적

## 4. 카프카 설정 및 운영

### 4.1 주요 설정 파라미터
- `replication.factor`: 복제본 수 (고가용성)
- `num.partitions`: 기본 파티션 수
- `retention.ms`: 메시지 보관 기간
- `cleanup.policy`: 메시지 정리 정책

### 4.2 모니터링 지표
- 메시지 처리량 (throughput)
- 지연시간 (latency)
- Consumer lag (소비 지연)
- 브로커 리소스 사용량

## 5. Spring Boot와 카프카 통합

### 5.1 의존성 추가
```gradle
implementation 'org.springframework.kafka:spring-kafka'
```

### 5.2 Producer 설정
```java
@Configuration
public class KafkaProducerConfig {
    @Bean
    public ProducerFactory<String, String> producerFactory() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        configProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        configProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        return new DefaultKafkaProducerFactory<>(configProps);
    }
    
    @Bean
    public KafkaTemplate<String, String> kafkaTemplate() {
        return new KafkaTemplate<>(producerFactory());
    }
}
```

### 5.3 Consumer 설정
```java
@Configuration
public class KafkaConsumerConfig {
    @Bean
    public ConsumerFactory<String, String> consumerFactory() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        configProps.put(ConsumerConfig.GROUP_ID_CONFIG, "order-consumer-group");
        configProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        configProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        return new DefaultKafkaConsumerFactory<>(configProps);
    }
    
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, String> factory = new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(consumerFactory());
        return factory;
    }
}
```

## 6. 실시간 주문정보 메시지 발행 아키텍처

### 6.1 메시지 발행 시점
- 결제 완료 (커밋) 후 즉시 발행
- 트랜잭션 성공을 보장하기 위해 `@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)` 사용

### 6.2 메시지 구조
```json
{
  "orderId": 12345,
  "userId": 67890,
  "orderStatus": "COMPLETED",
  "totalAmount": 50000,
  "finalAmount": 45000,
  "discountAmount": 5000,
  "paymentMethod": "BALANCE",
  "completedAt": "2024-01-15T10:30:00",
  "orderItems": [
    {
      "productId": 1,
      "productName": "상품명",
      "quantity": 2,
      "price": 25000
    }
  ]
}
```


